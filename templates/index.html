<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Booking Calendar</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.6/index.global.min.css" rel="stylesheet" />
    <style>
        body {
            padding-top: 56px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Disable styling for full slots (not owned by user) */
        .event-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
        }

        /* Highlight slots booked by current user */
        .event-user-booked {
            background-color: #007bff !important;
            border-color: #0056b3 !important;
        }

        .event-user-booked .fc-event-title {
            font-weight: bold;
        }

        .fc-timegrid-slot {
            height: 4em !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Gabinet - Rezerwacje</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain"
                aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMain">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/admin/">Admin</a></li>
                    <li class="nav-item d-none" id="nav-user-item"><a class="nav-link" href="#" id="nav-user"></a></li>
                    <li class="nav-item d-none" id="nav-mybookings-item"><a class="nav-link" href="#"
                            id="my-bookings-link">Moje rezerwacje</a></li>
                    <li class="nav-item d-none" id="nav-allbookings-item"><a class="nav-link" href="#"
                            id="all-bookings-link">Wszystkie rezerwacje</a></li>
                    <li class="nav-item d-none" id="nav-logout-item"><a class="nav-link" href="#"
                            id="logout-link">Wyloguj</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="register-link">Zarejestruj</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="login-link">Zaloguj</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="row">
            <div class="col-12 text-center my-4">
                <h1>Interaktywny Kalendarz Rezerwacji</h1>
                <p class="text-muted">Wybierz termin i zarezerwuj wizytę.</p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="calendar"></div>
            </div>
        </div>
    </main>

    <!-- Booking Modal (Bootstrap) -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zarezerwuj wizytę</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="existing-bookings" class="mb-3"></div>
                    <form id="booking-form">
                        <input type="hidden" id="slot-id" name="slot" />
                        <div class="mb-2">
                            <label class="form-label">Powód wizyty (opcjonalnie)</label>
                            <input class="form-control" name="reason" id="reason" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button id="booking-submit" type="submit" form="booking-form"
                        class="btn btn-primary">Zarezerwuj</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zaloguj się</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-2">
                            <label class="form-label">Nazwa użytkownika</label>
                            <input class="form-control" name="username" id="login-username" required />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Hasło</label>
                            <input type="password" class="form-control" name="password" id="login-password" required />
                        </div>
                    </form>
                    <div id="login-error" class="text-danger small"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" form="login-form" class="btn btn-primary">Zaloguj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zarejestruj się</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-2">
                            <label class="form-label">Nazwa użytkownika</label>
                            <input class="form-control" name="username" id="reg-username" required />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="reg-email" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Hasło</label>
                            <input type="password" class="form-control" name="password" id="reg-password" required />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Imię</label>
                            <input class="form-control" name="first_name" id="reg-first-name" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Nazwisko</label>
                            <input class="form-control" name="last_name" id="reg-last-name" />
                        </div>
                    </form>
                    <div id="register-error" class="text-danger small"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" form="register-form" class="btn btn-primary">Zarejestruj</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Scripts -->
    <!-- My Bookings Modal -->
    <div class="modal fade" id="myBookingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Moje rezerwacje</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="my-bookings-list">Ładowanie...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Bookings Modal (for Administrators) -->
    <div class="modal fade" id="allBookingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Wszystkie rezerwacje</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="all-bookings-list">Ładowanie...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Slot Modal (for Doctors) -->
    <div class="modal fade" id="addSlotModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dodaj nowy termin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-slot-form">
                        <div class="mb-3">
                            <label class="form-label">Data i godzina</label>
                            <input type="datetime-local" class="form-control" id="slot-datetime" required />
                        </div>
                    </form>
                    <div id="add-slot-error" class="text-danger small"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" form="add-slot-form" class="btn btn-primary">Dodaj termin</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.6/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.6/locales-all.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const bookingModalEl = document.getElementById('bookingModal');
            const bookingModal = new bootstrap.Modal(bookingModalEl);

            // Cache for user's bookings to quickly identify which slots belong to the user
            let userBookingsCache = {};

            // Function to fetch and cache user's bookings
            function refreshUserBookingsCache() {
                if (!isAuthenticated()) {
                    userBookingsCache = {};
                    return Promise.resolve();
                }
                return fetch('/api/bookings/mine/', { headers: getAuthHeaders() })
                    .then(res => {
                        if (!res.ok) return Promise.reject(new Error('Failed to fetch bookings'));
                        return res.json();
                    })
                    .then(data => {
                        const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
                        userBookingsCache = {};
                        items.forEach(b => {
                            if (b.status !== 'cancelled') {
                                userBookingsCache[b.slot] = b;
                            }
                        });
                    })
                    .catch(err => {
                        console.error('Failed to refresh user bookings cache:', err);
                        userBookingsCache = {};
                    });
            }

            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'pl',
                initialView: 'timeGridWeek',
                firstDay: 1,
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '01:00:00',
                selectable: true,
                selectMirror: true,
                select: function (info) {
                    // Allow doctors to add new slots by clicking empty space
                    handleDateSelect(info);
                },
                headerToolbar: { start: 'prev,next', center: 'title', end: 'timeGridDay,timeGridWeek,dayGridMonth' },
                buttonText: {
                    today: 'Dzisiaj',
                    month: 'Miesiąc',
                    week: 'Tydzień',
                    day: 'Dzień',
                    list: 'Lista'
                },
                events: function (fetchInfo, successCallback, failureCallback) {
                    const start = fetchInfo.startStr;
                    const end = fetchInfo.endStr;
                    fetch(`/api/appointments/?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`)
                        .then(res => res.json()).then(data => {
                            successCallback(data.map(slot => {
                                const hasUserBooking = userBookingsCache[slot.id];
                                const classNames = [];
                                if (!slot.is_booked) {
                                    // Free slot
                                } else if (hasUserBooking) {
                                    // Booked slot but user has booking: highlight in blue
                                    classNames.push('event-user-booked');
                                } else {
                                    // Booked slot, user doesn't have booking: dim it
                                    classNames.push('event-disabled');
                                }
                                return {
                                    id: slot.id,
                                    title: (!slot.is_booked ? 'Wolne' : 'Zarezerwowane') + (slot.doctor ? ` - ${slot.doctor}` : ''),
                                    start: slot.start,
                                    allDay: false,
                                    extendedProps: { is_booked: slot.is_booked, doctor: slot.doctor },
                                    classNames: classNames
                                };
                            }));
                        })
                        .catch(err => { console.error(err); failureCallback(err); });
                },
                eventClick: function (info) {
                    const slotId = info.event.id;

                    // Always fetch the appointment slot detail first to get availability.
                    fetch(`/api/appointments/${slotId}/`)
                        .then(r => r.json())
                        .then(slotData => {
                            document.getElementById('slot-id').value = slotId;
                            const submitBtn = document.getElementById('booking-submit');
                            // If user is not authenticated, do not show other users' bookings.
                            if (!isAuthenticated()) {
                                // For anonymous users show only availability: if booked -> 'Brak miejsc' and disable booking
                                if (slotData.is_booked) {
                                    document.getElementById('existing-bookings').textContent = 'Ten termin jest już zarezerwowany';
                                    submitBtn.disabled = true;
                                } else {
                                    document.getElementById('existing-bookings').textContent = '';
                                    submitBtn.disabled = false; // enable, but booking will require login when submitting
                                }
                                // Show the booking modal (user will be prompted to login when trying to submit)
                                bookingModal.show();
                                return;
                            }

                            // Authenticated users: fetch bookings and show details
                            const headers = getAuthHeaders();
                            fetch(`/api/bookings/?slot=${slotId}`, { headers })
                                .then(res => {
                                    if (!res.ok) {
                                        if (res.status === 401 || res.status === 403) {
                                            return [];
                                        }
                                        return res.json().then(err => Promise.reject(err));
                                    }
                                    return res.json();
                                })
                                .then(data => {
                                    const bookings = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
                                    // Check if user has a booking for this slot
                                    const userBooking = bookings.find(b => b.is_owner);
                                    if (userBooking) {
                                        // Show edit/cancel form for user's own booking
                                        const bookingContainer = document.getElementById('existing-bookings');
                                        bookingContainer.innerHTML = `
                                            <div class="alert alert-info">
                                                <strong>Twoja rezerwacja</strong>
                                                <div class="mt-2">
                                                    <label class="form-label">Powód (edycja)</label>
                                                    <textarea id="edit-reason" class="form-control">${userBooking.reason || ''}</textarea>
                                                </div>
                                                <div class="mt-2 d-flex gap-2">
                                                    <button id="edit-booking-btn" class="btn btn-sm btn-primary">Zaktualizuj</button>
                                                    <button id="cancel-booking-btn" class="btn btn-sm btn-danger">Anuluj rezerwację</button>
                                                </div>
                                            </div>
                                        `;
                                        document.getElementById('edit-booking-btn').addEventListener('click', () => {
                                            const newReason = document.getElementById('edit-reason').value;
                                            fetch(`/api/bookings/${userBooking.id}/`, {
                                                method: 'PATCH',
                                                headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
                                                body: JSON.stringify({ reason: newReason })
                                            }).then(r => {
                                                if (!r.ok) return r.json().then(e => Promise.reject(e));
                                                return r.json();
                                            }).then(() => {
                                                alert('Rezerwacja zaktualizowana');
                                                bookingModal.hide();
                                                refreshUserBookingsCache().then(() => {
                                                    calendar.refetchEvents();
                                                });
                                            }).catch(err => {
                                                alert('Błąd przy aktualizacji: ' + (err.detail || JSON.stringify(err)));
                                            });
                                        });
                                        document.getElementById('cancel-booking-btn').addEventListener('click', () => {
                                            if (confirm('Na pewno anulować rezerwację?')) {
                                                fetch(`/api/bookings/${userBooking.id}/cancel/`, {
                                                    method: 'POST',
                                                    headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders())
                                                }).then(r => {
                                                    if (!r.ok) return r.json().then(e => Promise.reject(e));
                                                    return r.json();
                                                }).then(() => {
                                                    alert('Rezerwacja anulowana');
                                                    bookingModal.hide();
                                                    refreshUserBookingsCache().then(() => {
                                                        calendar.refetchEvents();
                                                    });
                                                }).catch(err => {
                                                    alert('Błąd przy anulowaniu: ' + (err.detail || JSON.stringify(err)));
                                                });
                                            }
                                        });
                                        // Hide booking form and disable submit when editing own reservation
                                        document.getElementById('booking-form').style.display = 'none';
                                        submitBtn.style.display = 'none';
                                    } else {
                                        // Show empty state or allow new booking (only if slot is not booked)
                                        document.getElementById('existing-bookings').textContent = '';
                                        if (slotData.is_booked) {
                                            // Slot is booked - show message instead of form
                                            document.getElementById('existing-bookings').innerHTML = '<div class="alert alert-warning">Ten termin jest już zarezerwowany</div>';
                                            document.getElementById('booking-form').style.display = 'none';
                                            submitBtn.style.display = 'none';
                                        } else {
                                            // Slot is free
                                            document.getElementById('booking-form').style.display = 'block';
                                            submitBtn.style.display = 'block';
                                            submitBtn.disabled = false;
                                        }
                                    }
                                    bookingModal.show();
                                }).catch(err => {
                                    console.error(err);
                                    alert('Błąd przy pobieraniu rezerwacji');
                                });
                        }).catch(err => {
                            console.error(err);
                            alert('Błąd przy pobieraniu szczegółów slotu');
                        });
                }
            });
            calendar.render();

            document.getElementById('booking-form').addEventListener('submit', e => {
                e.preventDefault();
                const slot = document.getElementById('slot-id').value;
                const reason = document.getElementById('reason').value;
                const body = { slot: slot, reason };
                const submitBtn = document.getElementById('booking-submit');

                function doSubmit() {
                    submitBtn.disabled = true;
                    fetch('/api/bookings/', {
                        method: 'POST',
                        headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
                        body: JSON.stringify(body),
                    }).then(res => {
                        if (!res.ok) return res.json().then(err => Promise.reject(err));
                        return res.json();
                    }).then(data => {
                        bookingModal.hide();
                        refreshUserBookingsCache().then(() => {
                            calendar.refetchEvents();
                        });
                        const toastMsg = 'Rezerwacja została przyjęta.';
                        alert(toastMsg);
                    }).catch(err => {
                        const message = err.detail || JSON.stringify(err);
                        alert('Błąd rezerwacji: ' + message);
                    }).finally(() => {
                        submitBtn.disabled = false;
                    });
                }

                if (!isAuthenticated()) {
                    // ask user to login first, then submit
                    showLoginModalThen(() => doSubmit());
                    return;
                }
                doSubmit();
            });

            // No personal fields in booking form — booking requires authentication

            // simple hooks for register/login links (can be extended)
            // Authentication helpers
            const TOKEN_KEY = 'access_token';
            const REFRESH_KEY = 'refresh_token';

            function setTokens(access, refresh) {
                if (access) localStorage.setItem(TOKEN_KEY, access);
                if (refresh) localStorage.setItem(REFRESH_KEY, refresh);
                refreshUserBookingsCache().then(() => {
                    calendar.refetchEvents();
                    updateNavForAuth();
                });
            }
            function clearTokens() {
                localStorage.removeItem(TOKEN_KEY);
                localStorage.removeItem(REFRESH_KEY);
                userBookingsCache = {};
                calendar.refetchEvents();
                updateNavForAuth();
            }
            function getToken() {
                return localStorage.getItem(TOKEN_KEY);
            }
            function isAuthenticated() {
                return !!getToken();
            }
            function getAuthHeaders() {
                const token = getToken();
                return token ? { Authorization: 'Bearer ' + token } : {};
            }

            const loginModalEl = document.getElementById('loginModal');
            const loginModal = new bootstrap.Modal(loginModalEl);
            const registerModalEl = document.getElementById('registerModal');
            const registerModal = new bootstrap.Modal(registerModalEl);

            function updateNavForAuth() {
                const loggedIn = isAuthenticated();
                document.getElementById('nav-user-item').classList.toggle('d-none', !loggedIn);
                document.getElementById('nav-logout-item').classList.toggle('d-none', !loggedIn);
                document.getElementById('nav-mybookings-item').classList.toggle('d-none', !loggedIn);
                document.getElementById('login-link').classList.toggle('d-none', loggedIn);
                document.getElementById('register-link').classList.toggle('d-none', loggedIn);
                if (loggedIn) {
                    // Fetch current user's name and check if administrator
                    fetch('/api/auth/me/', { headers: getAuthHeaders() })
                        .then(r => {
                            if (!r.ok) throw new Error('Failed to fetch user');
                            return r.json();
                        })
                        .then(user => {
                            const fullName = (user.first_name + ' ' + user.last_name).trim() || user.username;
                            document.getElementById('nav-user').textContent = fullName;
                            // Check if user is administrator
                            checkIfAdministrator().then(isAdmin => {
                                document.getElementById('nav-allbookings-item').classList.toggle('d-none', !isAdmin);
                            });
                        })
                        .catch(err => {
                            console.error(err);
                            document.getElementById('nav-user').textContent = 'Zalogowany';
                            document.getElementById('nav-allbookings-item').classList.add('d-none');
                        });
                } else {
                    document.getElementById('nav-user').textContent = '';
                    document.getElementById('nav-allbookings-item').classList.add('d-none');
                }
            }

            function checkIfAdministrator() {
                // Try to access all_bookings endpoint to check if user is administrator
                return fetch('/api/bookings/all_bookings/', { headers: getAuthHeaders() })
                    .then(r => r.ok)
                    .catch(() => false);
            }

            function checkIfDoctor() {
                // Try to create a test slot to check if user is doctor (without actually creating it)
                // Or we can check by attempting to list with specific permissions
                return fetch('/api/appointments/', {
                    method: 'OPTIONS',
                    headers: getAuthHeaders()
                })
                    .then(r => r.ok)
                    .catch(() => false);
            }

            // Add Slot Modal
            const addSlotModalEl = document.getElementById('addSlotModal');
            const addSlotModal = new bootstrap.Modal(addSlotModalEl);
            let selectedSlotDate = null;

            function handleDateSelect(info) {
                if (!isAuthenticated()) {
                    calendar.unselect();
                    return;
                }

                // Check if user is doctor
                checkIfDoctor().then(isDoctor => {
                    if (!isDoctor) {
                        // Check if trying to create via API works
                        fetch('/api/appointments/', {
                            method: 'OPTIONS',
                            headers: getAuthHeaders()
                        }).then(r => {
                            if (r.ok && r.headers.get('Allow')?.includes('POST')) {
                                showAddSlotModal(info.start);
                            } else {
                                calendar.unselect();
                            }
                        });
                    } else {
                        showAddSlotModal(info.start);
                    }
                });
            }

            function showAddSlotModal(date) {
                selectedSlotDate = date;
                const dateStr = date.toISOString().slice(0, 16);
                document.getElementById('slot-datetime').value = dateStr;
                document.getElementById('add-slot-error').textContent = '';
                addSlotModal.show();
                calendar.unselect();
            }

            document.getElementById('add-slot-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const datetime = document.getElementById('slot-datetime').value;

                if (!datetime) {
                    document.getElementById('add-slot-error').textContent = 'Wybierz datę i godzinę';
                    return;
                }

                const startDate = new Date(datetime);

                fetch('/api/appointments/', {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
                    body: JSON.stringify({
                        start: startDate.toISOString()
                    })
                })
                    .then(res => {
                        if (!res.ok) return res.json().then(err => Promise.reject(err));
                        return res.json();
                    })
                    .then(data => {
                        addSlotModal.hide();
                        calendar.refetchEvents();
                        alert('Termin został dodany');
                    })
                    .catch(err => {
                        const message = err.detail || err.start?.[0] || JSON.stringify(err);
                        document.getElementById('add-slot-error').textContent = 'Błąd: ' + message;
                    });
            });

            // Show login modal and run callback after successful login
            let loginPendingCallback = null;

            function showLoginModalThen(cb) {
                // Try normal bootstrap API first, fall back to DOM toggling if the dialog remains hidden
                loginPendingCallback = cb;
                showBootstrapModal(loginModal, loginModalEl);
            }

            // Global login handler - triggers once when form is submitted
            document.getElementById('login-form').addEventListener('submit', function handleLogin(e) {
                e.preventDefault();
                document.getElementById('login-error').textContent = '';
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                fetch('/api/auth/token/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                }).then(r => {
                    if (!r.ok) {
                        return r.json().then(err => Promise.reject(err));
                    }
                    return r.json();
                }).then(data => {
                    if (data.access) {
                        setTokens(data.access, data.refresh);
                        loginModal.hide();
                        // Clear form
                        document.getElementById('login-username').value = '';
                        document.getElementById('login-password').value = '';
                        // Execute pending callback if any
                        if (typeof loginPendingCallback === 'function') {
                            const cb = loginPendingCallback;
                            loginPendingCallback = null;
                            cb();
                        }
                    } else {
                        document.getElementById('login-error').textContent = data.detail || 'Logowanie nie udało się';
                    }
                }).catch(err => {
                    document.getElementById('login-error').textContent = err.detail || 'Błąd logowania';
                    console.error(err);
                });
            });

            // Register handler
            document.getElementById('register-link').addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('register-error').textContent = '';
                registerModal.show();
            });
            document.getElementById('register-form').addEventListener('submit', e => {
                e.preventDefault();
                document.getElementById('register-error').textContent = '';
                const username = document.getElementById('reg-username').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const first_name = document.getElementById('reg-first-name').value;
                const last_name = document.getElementById('reg-last-name').value;
                fetch('/api/auth/register/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, first_name, last_name }),
                }).then(r => {
                    if (!r.ok) {
                        return r.json().then(err => Promise.reject(err));
                    }
                    return r.json();
                }).then(data => {
                    if (data.access) {
                        setTokens(data.access, data.refresh);
                        registerModal.hide();
                        // Clear form
                        document.getElementById('reg-username').value = '';
                        document.getElementById('reg-email').value = '';
                        document.getElementById('reg-password').value = '';
                        document.getElementById('reg-first-name').value = '';
                        document.getElementById('reg-last-name').value = '';
                    } else if (data.detail) {
                        document.getElementById('register-error').textContent = data.detail;
                    } else {
                        document.getElementById('register-error').textContent = JSON.stringify(data);
                    }
                }).catch(err => {
                    document.getElementById('register-error').textContent = err.detail || 'Błąd rejestracji';
                    console.error(err);
                });
            });

            // Login link shows login modal
            document.getElementById('login-link').addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('login-error').textContent = '';
                loginModal.show();
            });

            // Logout
            document.getElementById('logout-link').addEventListener('click', e => {
                e.preventDefault();
                clearTokens();
                updateNavForAuth();
            });

            // My bookings: fetch and show user's bookings in modal
            const myBookingsModalEl = document.getElementById('myBookingsModal');
            const myBookingsModal = new bootstrap.Modal(myBookingsModalEl);

            document.getElementById('my-bookings-link').addEventListener('click', e => {
                e.preventDefault();
                if (!isAuthenticated()) {
                    showLoginModalThen(() => fetchAndShowMyBookings());
                    return;
                }
                fetchAndShowMyBookings();
            });

            function fetchAndShowMyBookings() {
                const container = document.getElementById('my-bookings-list');
                container.textContent = 'Ładowanie...';
                fetch('/api/bookings/mine/', { headers: getAuthHeaders() })
                    .then(res => {
                        if (!res.ok) return res.json().then(err => Promise.reject(err));
                        return res.json();
                    })
                    .then(data => {
                        const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
                        if (items.length === 0) {
                            container.innerHTML = '<div class="text-muted">Brak rezerwacji</div>';
                        } else {
                            const list = document.createElement('div');
                            list.className = 'list-group';

                            // Fetch slot details for all bookings
                            const slotPromises = items.map(b =>
                                fetch(`/api/appointments/${b.slot}/`)
                                    .then(r => r.ok ? r.json() : null)
                                    .catch(() => null)
                            );

                            Promise.all(slotPromises).then(slots => {
                                items.forEach((b, idx) => {
                                    const el = document.createElement('div');
                                    el.className = 'list-group-item d-flex justify-content-between align-items-start' + (b.is_owner ? ' bg-light border-2 border-primary' : '');
                                    const left = document.createElement('div');

                                    const slot = slots[idx];
                                    let slotInfo = `Slot #${b.slot}`;
                                    if (slot && slot.start) {
                                        const slotDate = new Date(slot.start);
                                        const formattedSlot = slotDate.toLocaleDateString('pl-PL', {
                                            weekday: 'long',
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        slotInfo = formattedSlot;
                                        if (slot.doctor) {
                                            slotInfo += ` - ${slot.doctor}`;
                                        }
                                    }

                                    left.innerHTML = `<div><strong>Termin wizyty:</strong> ${slotInfo}</div><div><strong>Powód:</strong> ${b.reason || '<em>—</em>'}</div>`;
                                    const right = document.createElement('div');
                                    if (b.status !== 'cancelled') {
                                        const btn = document.createElement('button');
                                        btn.className = 'btn btn-sm btn-danger';
                                        btn.textContent = 'Anuluj';
                                        btn.addEventListener('click', () => cancelBooking(b.id, el));
                                        right.appendChild(btn);
                                    } else {
                                        right.innerHTML = '<span class="text-muted">Anulowane</span>';
                                    }
                                    el.appendChild(left);
                                    el.appendChild(right);
                                    list.appendChild(el);
                                });
                                container.innerHTML = '';
                                container.appendChild(list);
                            });
                        }
                        myBookingsModal.show();
                    }).catch(err => {
                        container.textContent = 'Błąd przy pobieraniu rezerwacji';
                        console.error(err);
                    });
            }

            function cancelBooking(bookingId, elementEl) {
                if (!confirm('Na pewno anulować rezerwację?')) return;
                fetch(`/api/bookings/${bookingId}/cancel/`, {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeaders()),
                }).then(res => {
                    if (!res.ok) return res.json().then(err => Promise.reject(err));
                    return res.json();
                }).then(data => {
                    // remove or mark element as cancelled
                    elementEl.querySelector('div:nth-child(1)').innerHTML += '<div class="text-success">Anulowano</div>';
                    elementEl.querySelector('button')?.remove();
                    // refresh calendar availability and close modal
                    refreshUserBookingsCache().then(() => {
                        calendar.refetchEvents();
                        bookingModal.hide();
                    });
                }).catch(err => {
                    console.error(err);
                    alert('Błąd przy anulowaniu rezerwacji');
                });
            }

            // All bookings for administrators
            const allBookingsModalEl = document.getElementById('allBookingsModal');
            const allBookingsModal = new bootstrap.Modal(allBookingsModalEl);

            document.getElementById('all-bookings-link').addEventListener('click', e => {
                e.preventDefault();
                if (!isAuthenticated()) {
                    showLoginModalThen(() => fetchAndShowAllBookings());
                    return;
                }
                fetchAndShowAllBookings();
            });

            function fetchAndShowAllBookings() {
                const container = document.getElementById('all-bookings-list');
                container.textContent = 'Ładowanie...';
                fetch('/api/bookings/all_bookings/', { headers: getAuthHeaders() })
                    .then(res => {
                        if (!res.ok) return res.json().then(err => Promise.reject(err));
                        return res.json();
                    })
                    .then(data => {
                        const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
                        if (items.length === 0) {
                            container.innerHTML = '<div class="text-muted">Brak rezerwacji</div>';
                        } else {
                            const list = document.createElement('div');
                            list.className = 'list-group';

                            // Fetch slot details for all bookings
                            const slotPromises = items.map(b =>
                                fetch(`/api/appointments/${b.slot}/`)
                                    .then(r => r.ok ? r.json() : null)
                                    .catch(() => null)
                            );

                            Promise.all(slotPromises).then(slots => {
                                items.forEach((b, idx) => {
                                    const el = document.createElement('div');
                                    el.className = 'list-group-item d-flex justify-content-between align-items-start';
                                    const left = document.createElement('div');

                                    const slot = slots[idx];
                                    let slotInfo = `Slot #${b.slot}`;
                                    if (slot && slot.start) {
                                        const slotDate = new Date(slot.start);
                                        const formattedSlot = slotDate.toLocaleDateString('pl-PL', {
                                            weekday: 'long',
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        slotInfo = formattedSlot;
                                        if (slot.doctor) {
                                            slotInfo += ` - ${slot.doctor}`;
                                        }
                                    }

                                    // Display user info
                                    let userName = 'Nieznany';
                                    if (b.user) {
                                        if (typeof b.user === 'object') {
                                            userName = b.user.full_name || b.user.username;
                                        } else {
                                            userName = b.user;
                                        }
                                    }
                                    const statusBadge = b.status === 'cancelled' ? '<span class="badge bg-danger">Anulowane</span>' : '<span class="badge bg-success">Potwierdzone</span>';

                                    left.innerHTML = `<div><strong>Użytkownik:</strong> ${userName} ${statusBadge}</div><div><strong>Termin wizyty:</strong> ${slotInfo}</div><div><strong>Powód:</strong> ${b.reason || '<em>—</em>'}</div>`;
                                    const right = document.createElement('div');
                                    if (b.status !== 'cancelled') {
                                        const btn = document.createElement('button');
                                        btn.className = 'btn btn-sm btn-danger';
                                        btn.textContent = 'Anuluj';
                                        btn.addEventListener('click', () => cancelBooking(b.id, el));
                                        right.appendChild(btn);
                                    }
                                    el.appendChild(left);
                                    el.appendChild(right);
                                    list.appendChild(el);
                                });
                                container.innerHTML = '';
                                container.appendChild(list);
                            });
                        }
                        allBookingsModal.show();
                    }).catch(err => {
                        container.textContent = 'Błąd przy pobieraniu rezerwacji: ' + (err.detail || 'Brak dostępu');
                        console.error(err);
                    });
            }

            // utility: robust modal show fallback
            function showBootstrapModal(modalInstance, modalEl) {
                try {
                    modalInstance.show();
                } catch (err) {
                    // ignore
                }
                // if modal dialog not visible after a short delay, force it
                setTimeout(() => {
                    if (!modalEl.classList.contains('show') || window.getComputedStyle(modalEl).display === 'none') {
                        modalEl.classList.add('show');
                        modalEl.style.display = 'block';
                        modalEl.setAttribute('aria-hidden', 'false');
                        // add backdrop if missing
                        if (!document.querySelector('.modal-backdrop')) {
                            const bd = document.createElement('div');
                            bd.className = 'modal-backdrop fade show';
                            document.body.appendChild(bd);
                        }
                    }
                }, 50);
            }

            // initialize nav state and load user bookings cache
            updateNavForAuth();
            refreshUserBookingsCache().then(() => {
                calendar.refetchEvents();
            });
        });
    </script>
</body>

</html>